# 人员定位系统-安装部署

## 操作系统

请使用win server 2016以上版本的操作系统

Windows Server 2016 Data Center [下载地址](ed2k://|file|cn_windows_server_2016_vl_x64_dvd_11636695.iso|6302720000|44742A3D464B9765203E2A4DB73FF704|/)

Windows Server 2019 [下载地址](ed2k://|file|cn_windows_server_2019_updated_march_2019_x64_dvd_c1ffb46c.iso|5347280896|49FCF8C558517608537E0396854560D6|/)

## 数据库

请使用SqlServer 2016 sp1

MsSql 2016 sp1 [下载地址](ed2k://|file|cn_sql_server_2016_enterprise_with_service_pack_1_x64_dvd_9538279.iso|2959722496|E3F5E07B85F0AB42CA115CE1D6CA27D1|/)



## 软件环境

.NET FRAMEWORK 4.7

## 文本编缉器

请务必不要使用微软自带的记事本.exe 英文名称notepad.exe

windows记事本另存为utf-8编码会在文件开头加上EF BB BF三个字节.即`BOM`



以下为推荐使用的编缉器

[akeipad ](https://sm.myapp.com/original/Development/AkelPad-4.9.8-setup.exe)

[vscode](http://xz6.jb51.net:81/201804/tools/VSCodesetup-x64_jb51.rar)

[editplus](https://dl.softmgr.qq.com/original/Development/epp520_2281_64bit_5.2.2281.0.exe)



## 队列软件

Redis

![](https://i.loli.net/2019/11/04/eI4lKVZ3dkRSwPC.png)

测试环境:命令行启动

生产环境:设置服务->启动服务

## 前置接收

软件名称:`Castle.Lora.SW5.FrontServer.Console.Ss`

主要文件:

![](https://i.loli.net/2019/11/04/dXy7b2IxJaYBZPR.png)

使用文本编辑器(非notepad)打开 `Castle.Lora.SW5.FrontServer.Console.Ss.config` ,如下图所示:

![](https://i.loli.net/2019/11/04/1SwVaZQbIgPlXx3.png)

`proname` 软件名称.会显示在标题上面

`port`  TCP Server监听的端口.

>  一个端口只能被一个Tcp Server实例监听. 同端口打开第二个监听将会报错

`RedisServer ` Redis服务监听的地址.默认端口6379.

`RedisDB` Redis服务中默认存放的数据库名称.用数字表示.一般有0-15总共16个数据库

![](https://i.loli.net/2019/11/04/RpbTuYsF4XqmOBa.png)



> 建议不同项目用不同的数据库

`RedisQueueKey`  Redis服务中用于存放队列的键值.

> 请务必将不同业务用不同的键值区分



软件使用方式: 双击exe打开

![](https://i.loli.net/2019/11/04/CjWoehcQpi12Sy7.png)



## 位置计算

软件名称 `Castle.Lora.SW5.LocServer.Console.Ss`

主要文件 :

![](https://i.loli.net/2019/11/04/hf941BpCUSIwZtF.png)

使用文本编缉器(非notepad)打开`Castle.Lora.SW5.LocServer.Console.Ss.exe.config`

![](https://i.loli.net/2019/11/04/vJuCK34jIO9LNai.png)

`proname` 软件的名称,会在界面标题显示

`dbtype`  数据库类型. 此处默认sqlserver

`RedisServer` Redis服务器的地址.默认端口6379

`RedisDb1`  Redis数据库.此处的数据库要和前置接收配置档中的RedisDb一致

`RedisDb2` Redis数据库.此处的数据库要和区域计算配置档中的RedisDb一致

`RedisQueueKey1` Redis数据库存放队列的键值. 此处的键值要和前置接收配置档中的RedisQueueKey一致

`RedisQueueKey2` Redis数据库存放队列的键值. 此处的键值要和前置区域计算档中的RedisQueueKey一致

`chksum` 推送长度校验,[目前无效]

`lessrssi` rssi最低过滤阈值.只要低于这个值的都会被过滤

`PreFilter` 信标取最强rssi的多少个.默认3

`PosType` 算法模式.目前有两种算法. 0:偏移加权算法  1:三角定位算法

`maxrssi` rssi最大参考值.用于PosType=0时的加权计算

`n` 环境衰减因子 .用于PosType=1时计算

`absrssi` 1米场强绝对值 .用于PosType=1时计算



`connectionString 的connstr` 此处为数据库的连接字符串,请按实际数据库配置



使用方法: 双击exe打开即可

![](https://i.loli.net/2019/11/04/t9IS5nDe3lFsN26.png)



## 区域计算

软件名称:`CASTLENEW.SW.5.RegionServer.Console.Ss`

主要文件:

![](https://i.loli.net/2019/11/04/GE3Zrkj8FQSWUi4.png)

使用文本编缉器(非notepad)打开`Castle.Lora.SW5.RegionServer.Console.Ss.exe.config`文件

![](https://i.loli.net/2019/11/04/NbWLfIAYktzVwZx.png)

`proname` 软件名称 ,将会显示在界面标题

`dbtype` 数据库类型,此处默认sqlserver

`RedisServer` redis服务的连接地址.默认6379

`RedisDb`  redis数据库,此处的数据库需要和位置计算的redisdb2相同

`RedisQueueKey` redis数据库存放键值的名称, 此处要和位置计算的RedisQueueKey2相同



`connectionStrings 的connstr` 此处是数据库的连接字符串,请按照实际数据库连接填写

使用方式: 双击exe打开即可

## 网站后端API

主要文件

![](https://i.loli.net/2019/11/04/5mtVWDhFeskwqIp.png)

在IIS中创建一个网站 命名为 `CASTLENEW.API`

网站指向根目录 为 这些文件所在的目录

端口请使用一个未被占用的端口, 此处建议6678

.NET应用程序请使用ASP.NET 4.0模式.

> 这里的ASP.NET4.0并不是指.net framework 4.0.而是IIS配置应用程序4.0

使用文本编缉器(非notepad)打开`Web.config`

![](https://i.loli.net/2019/11/04/PrhwycI4qFCWxza.png)

`dbtype` 数据库类别, 此处默认sqlserver

`LocationHisPartLessMode` 历史轨迹中用于减少垃圾数据的屏蔽模式.有COUNT和TIME,此处请使用COUNT

`LocationHisPartLess` 历史轨迹中用于减少垃圾数据的屏蔽模式计数.如果上面是COUNT那么这里就是次数.如果上面是TIME那么这里就是秒

`WebMainUrl` webmain访问地址 ,用于添加和删除卡片时将webmain中尝试一同更新(测试功能)

`WebMainDefaultStation` webmain基站号, 用于添加和删除卡片时将webmain中尝试一同更新(测试功能)

`PublishPlanBeforeToday` 用于能否发布昨天巡检的开关. 0为可以发布昨天巡检 1为禁止发布昨天巡检也就是每次发布会跳过今日之前的数据

`connectionStrings 的 connstr` 数据库的连接字符串,请按照实际情况填写

## 图片服务器API

主要文件

![](https://xindoo-doc.oss-cn-shanghai.aliyuncs.com/doc20191104152751.png)

在IIS中创建一个网站 命名为 `CASTLENEW.IMAGESERVER`

网站指向根目录 为 这些文件所在的目录

端口请使用一个未被占用的端口, 此处建议6680

.NET应用程序请使用ASP.NET 4.0模式.  

> 这里的ASP.NET4.0并不是指.net framework 4.0.而是IIS配置应用程序4.0

使用文本编缉器(非notepad)打开`Web.config`

![](https://xindoo-doc.oss-cn-shanghai.aliyuncs.com/doc20191104153040.png)

`dbtype` 数据库类别.默认sqlserver

`connectionStrings 的 connstr` 数据库的连接字符串,请按照实际情况填写.

注意如下配置不要修改 .涉及到上传文件的大小限制

~~~xml
<httpRuntime maxRequestLength="102400" executionTimeout="200" enable="true"
             targetFramework="4.5.1" />
 <requestFiltering>
   <requestLimits maxAllowedContentLength="104857600" />
</requestFiltering>
~~~



